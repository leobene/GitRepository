\documentclass[dissertacao,modelo1,brazil]{ThesisPUC}

\usepackage{graphicx}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\newcommand{\Rset}{\mathbb{R}}
%\newcommand{\Zset}{\mathbb{Z}}

\newcommand{\script}{\emph{script}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\autor{Leonardo de Paula Batista Benevides}
\orientador{Waldemar Celes}
\orientadorR{Celes, Waldemar} 
%TODO: mudar o t�tulo
\titulo{T\'{e}cnicas de instanciacao aplicadas \`{a} renderizacao eficiente de campos tensoriais}
%\subtitulo{Das hiperflorestas at\'{e} complexos celulares}
\dia{21} \mes{Novembro} \ano{2012}

\cidade{Rio de Janeiro}
\CDD{510}
\departamento{Inform\'atica}
\programa{}
\centro{Centro T\'{e}cnico Cient\'{i}fico}
\universidade{Pontif\'{i}cia Universidade Cat\'{o}lica do Rio de Janeiro}
\uni{PUC--Rio}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\banca{
%}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\curriculo{%}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\agradecimentos{%}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%TODO:
\chaves{%
  \chave{Linguagem visual, Programa��o por usu�rios finais}%
}

\resumo{
Este documento apresenta os principais conceitos de
um sistema de \script{} de uma aplica��o
voltada para o p�s-processamento de simula��es de reservat�rios de petr�leo
e a proposta e implementa��o de uma ferramenta que disponibilze parte 
dos recursos  obtidos a partir dos \emph{scripts} � usu�rios n�o programadores.
A ferramenta implementada  � uma
uma calculadora de propriedades que permite que o usu�rio gere novas 
propriedades a partir de simples express�es aritm�ticas desenvolvidas em
uma interface gr�fica similar a uma calculadora comum. 
Este documento tamb�m apresenta um breve resumo dos estudos feitos acerca
de linguagens de programa��o visual e a proposta e in�cio de implementa��o
de uma linguagem de programa��o visual simplificada.
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chavesuk{
  \chave{Visual language, End users pogramming }%
}

\titulouk{A visual programming tool for postprocessing of oil reservoir simulations  }

\resumouk{%
This document presents the main concepts of a 
script system of an application focused on the 
postprocessing of oil reservoir simulations
and the proposal and the implementation of a tool
that provides part of the scripts resources to users that are not programmers.
This tool is an property calculator that lets the 
users generate new properties from simple arithmetic
expressions that are developed in an graphic interface that
looks like an ordinary calculator.
This document also presents a brief summary 
of studies about visual programming languages
and the proposal and the beginning of a
simplified visual programming language.

}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\modotabelas{figtab} % nada, fig, tab ou figtab

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\epigrafe{%}
%\epigrafeautor{Wassily Kandinsky}
%\epigrafelivro{Regards sur le pass\'{e}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\chapter{Introdução}

O \textbf{Geresim} \'{e} uma aplica\c{c}\~ao desenvolvida por meio de uma
parceria firmada entre o \textbf{TeCGraf/PUC-Rio}
e a \textbf{PETROBRAS (E\&P/ER)} com o intuito de melhorar o processo de modelagem do escoamento em meio 
poroso em reservat\'{o}rios de petr\'{o}leo. Ele \'{e} constitu�\'{i}o de um ambiente de trabalho que permite 
construir, alterar, manter, importar e exportar modelos num\'{e}ricos para os principais simuladores 
comerciais, tirando proveito de uma s\'{e}rie de facilidades voltadas para a agilidade e a efic\'{a}cia 
da montagem dos modelos. Adicionalmente, o \textbf{Geresim} executa uma an\'{a}lise de consist\^{e}ncia que 
elimina a maioria dos erros mais comuns no processo de modelagem e oferece um ambiente para 
analisar modelos e dados de reservat\'{o}rios, utilizando visualiza\c{c}\~{o}es bidimensionais de mapas 
e se\c{c}\~{o}es, tridimensionais do modelo ou gr\'{a}ficas de elementos do modelo\cite{Tecg06}. 

Uma das aplica\c{c}\~{o}es com maior usabilidade no \textbf{Geresim} \'{e} um poderoso sistema de \emph{scripts} que possibilita
acesso program\'{a}vel aos dados dos modelos de reservat\'{o}rios visualizados e disponibiliza diversos 
recursos como gera\c{c}\~{a}o de dados de forma procedimental e flexibiliza\c{c}\~{a}o
nas opera\c{c}\~{o}es com os dados.
Esse acesso program\'{a}vel \'{e} feito atrav\'{e}s da linguagem de programa\c{c}\~{a}o \textbf{Lua} \cite{Ieru03}.

%TODO : melhorar esse paragrafo
%nocoes de orienta�ao a objetos, iteradores de lua
No entanto, como requer certo conhecimento de t�cnicas de programa��o do usu�rio e este na maioria das
vezes tem pouca ou at� mesmo nenhuma experi�ncia como programador, 
o sistema de \emph{scripts} muitas vezes 
acaba sendo subutilizado e os que necessitam do mesmo acabam delegando aos pr�prios desenvolvedores 
do software a implementa��o de novos \emph{scripts} de programa��o.

Nesse contexto, torna-se interessante e necess�rio (pois, foi sugerido pelo pr�prio cliente) o estudo
de alternativas � programa��o textual % desenvolvimento de scripts atrav�s de mecanismos de programa��o visual
que disponibilize ao usu�rio n�o programador pelo menos parte dos recursos do sistema de \emph{scripts}
do \textbf{Geresim}.
%O uso de programa��o visual tem se mostrado interessante em sistemas que apresentem um dom�nio
%espec�fico, como o descrito acima, pois � poss�vel manter-se dentro do estilo de comunica��o do
%dom�nio utilizando artefatos visuais que reflitam necessidades particulares, diagramas e o
%vocabul�rio espec�fico do dom�nio sem nunca precisar deixar esse estilo de comunica��o [GrPe96].
%TODO : melhorar esse paragrafo
Por isso, esse projeto teve como metas principais pesquisar e desenvolver ferramentas
que cumpram esse objetivo.

Este trabalho foi dividido da seguinte forma: a se��o 2 apresenta de forma breve o atual sistema
de script do \textbf{Geresim}; a se��o 3 descreve a implementa��o e funcionamento de uma calculadora de 
propriedades desenvolvida no projeto; a se��o 4 apresenta um breve resumo dos estudos feitos
acerca de lingugens de programa��o visual; a se��o 5 apresenta  o in�cio da 
implementa��o de uma ferramenta de programa��o visual; a se��o 6 apresenta algumas conclus�es
e propostas de trabalhos futuros.


\chapter{O sistema de Scripts}

O sistema de \emph{scripts} do \textbf{Geresim} possibilita acesso program�vel aos dados dos 
modelos de reservat�rio visualizados. Esse acesso program�vel � feito atrav�s da 
linguagem de programa��o \textbf{Lua}. Por isso o sistema disponibiliza diversos recursos
de programa��o sendo poss�vel a implementa��o de \emph{scripts} diversos que podem
acessar todos os dados dos modelos de reservat�rio.

Assim � poss�vel gerear dados de forma procedimental, como cirar novos
modelos e novos dados a serem associados a modelos, manipular dados de forma 
flex�vel, como us�-los como operandos de diversas opera��es sem muitas restri��es
e criar \emph{scripts} tempor�rios. Por isso o sistema pode funcionar como uma m�quina
de calcular que opera com os dados dos modelos, recurso que ser� mais discutido
na se��o 3.

Nessas se��o ser� feita uma r�pida descri��o da linguagem de programa��o \textbf{Lua} e 
uma apresenta��o do funcionamento do sistema de \script{} do \textbf{Geresim}.

\section{Lua}


\textbf{Lua} � uma linguagem de programa��o poderosa, r�pida e leve, projetada justamente para estender aplica��es.
Combina sintaxe simples para programa��o procedural com poderosas constru��es para descri��o de dados 
baseadas em tabelas associativas e sem�ntica extens�vel. \textbf{Lua} � tipada dinamicamente, � interpretada a 
partir de bytecodes para uma m�quina virtual baseada em registradores, e tem gerenciamento autom�tico 
de mem�ria com coleta de lixo incremental. Essas caracter�sticas fazem de \textbf{Lua} uma linguagem ideal 
para configura��o, automa��o (\emph{scripting}) e prototipagem r�pida. A linguagem
� usada em muitas aplica��es
industriais, com �nfase em sistemas embutidos e jogos, onde � atualmente a linguagem de
\script{} mais usada. \textbf{Lua} tem uma merecida reputa��o de �timo desempenho, em v�rios benchmarks 
aparece como a linguagem mais r�pida dentre as linguagens de \script{} interpretadas.
\cite{Lua}

Mais do que apenas estender aplica��es, \textbf{Lua}
tamb�m suporta uma abordagem de desenvolvimento de software 
baseada em componentes, onde � poss�vel criar aplica��es
juntando componentes de alto-n�vel pr�-existentes.
Normalmente esses componentes s�o escritos em linguagens 
compiladas e estaticamente tipadas como \textbf{C} ou \textbf{C}++.
Assim, \textbf{Lua} pode ser usada conectar tais componentes, 
que normalmente representam conceitos mais concretos
e de baixo n�vel (como por exemplo estruturas de dados) que n�o est�o sujeitos a muitas altera��es
durante o desenvolvimento do programa e normalmente exigem um maior poder de processamento.
\cite{Ieru03}

%talvez falar mais sobre os recurso e estilo de programa��o, meta-mecanismos e tabelas

%\newpage

%More than being an extensible language, Lua is also a glue language. Lua supports a component-based approach to software development, where we create an application by gluing together existing high-level components. Usually, these components are written in a compiled, statically typed language, such as C or C++; Lua is the glue that we use to compose and connect those components. Usually, the components (or objects) represent more concrete, low-level concepts (such as widgets and data structures) that are not subject to many changes during program development and that take the bulk of the CPU time of the final program. Lua gives the final shape of the application, which will probably change a lot during the life cycle of the product. However, unlike other glue technologies, Lua is a full-fledged language as well. Therefore, we can use Lua not only to glue components, but also to adapt and reshape them, or even to create whole new components. 

\section{Conceitos b�sicos do sistema de Script}

O sistema de macros do \textbf{Geresim} prov� acesso a diversos objetos que 
representam o modelo e seus dados. Para cada objeto, tem-se acesso a suas 
informa��es e a um conjunto de m�todos que permitem a 
manipula��o altera��o das informa��es associadas. Os objetos a que se tem 
acesso no sistema de macros s�o: 

\begin{itemize}
  \item \textbf{Model:} 
  objeto que representa um modelo de reservat�rio;
  \item \textbf{Field:} 
  objeto que representa um campo do modelo;
  \item \textbf{Region:} 
  objeto que representa uma regi�o do modelo;
  \item \textbf{Well:} 
  objeto que representa um po�o do modelo;
  \item \textbf{Completion:} 
  objeto que representa uma completa��o de um po�o do modelo;
  \item \textbf{Data:}
  objeto que representa um conjinto de valores de propriedades, podendo ser
  dos seguintes tipos:
  \begin{itemize}
    \item \textbf{MapProp:}
    propriedade de mapa, representada por um vetor de 
    dados de dimens�o 4: ni x nj x nk x n�mero de timesteps\footnote{explica��o de timestep} de mapa; 
    \item \textbf{FieldProp:}
    propriedade de campo, representada por um vetor de 
    dados de dimens�o 1: n�mero de timesteps de po�o; 
    \item \textbf{RegionProp:}
    propriedade de regi�o, representada por um vetor de 
    dados de dimens�o 2: n�mero de regi�es x n�mero de timesteps de 
    po�o;  
    \item \textbf{GroupProp:}
    propriedade de grupo, representada por um vetor de 
    dados de dimens�o 2: n�mero de grupos x n�mero de timesteps de 
    po�o;  
    \item \textbf{WellProp:}
    propriedade de po�o, representada por um vetor de 
    dados de dimens�o 2: n�mero de po�os x n�mero de timesteps de 
    po�o; 
    \item \textbf{CompProp:}
    propriedade de completa��o, representada por um 
    vetor de dados de dimens�o 3: n�mero de po�os x n�mero de 
    m�ximo de completa��es por po�o x n�mero de timesteps de po�o;
    \item \textbf{ExtraProp:}
    propriedade avulsa, representada por um vetor de 
    dados de dimens�o 1: n�mero de timesteps de po�o;
  \end{itemize}
  \item \textbf{Slice:}
  refer�ncia para uma ``fatia'' de um determinado conjunto de dados.
\end{itemize}

Pode-se ainda criar refer�ncias para outras por��es de um dado. Por exemplo, � 
v�lido criar uma refer�ncia para um mapa associado a um determinado timestep.

%TODO: melhorar esse paragrafo
Existem dois tipos de vetores de dados: dados originais associados ao modelo e 
dados criados dinamicamente pelo sistema de \script{}. Os dados originais podem 
ser consultados, mas n�o podem ser alterados. J� os dados criados 
dinamicamente podem ser livremente alterados. Analogamente, refer�ncias a 
dados originais n�o s�o edit�veis, enquanto que refer�ncias a dados criados 
dinamicamente s�o edit�veis (na verdade, altera-se o vetor de dados 
referenciado). 

Logicamente, o programa de \script{} pode tamb�m incluir a manipula��o de 
valores dos tipos existentes em \textbf{Lua}: booleanos, valores escalares, cadeias de 
caracteres (\emph{string}), entre outros. 

\section{Acesso e cria��o de dados}

%TODO: melhorar esse paragrafo
O objeto \emph{Model} representa um resultado de simula��o, com suas propriedades 
de mapa e de po�o. A fun��o que implementa o \script{} recebe um ou mais 
modelos como par�metro de entrada e a partir desses objetos \emph{Model}, tem-se acesso 
a seus atributos e seus m�todos.

� atrav�s dos atributos de um objeto \emph{Model} que se d� o acesso program�vel aos dados
dos modelos de reservat�rio. Esses dados n�o podem ser alterados no \script, � poss�vel apenas
consulta-los e usar os valores retornados. Assim � poss�vel acessar dados de geometria,
como o n�mero de c�lulas nas dire��es I, J ou K, acessar dados relacionados a timesteps,
acessar dados relacionados aos demais objetos do modelo, como o n�mero de po�os ou
de regi�es, acessar os pr�prios objetos e tamb�m a todas as propriedades do modelo.

Como dito acima, o objeto \emph{Model} tamb�m prov� um conjunto de m�todos
que possibilitam o acesso � estrutura do reservat�rio, a cria��o de novos 
modelos, cria��o de novos vetores de propriedade, verificar a exist�ncia
de timesteps e propriedades e associar os novos dados vetoriais criados
durante o \script{} aos modelos.

\section{Vetores de dados de propriedades}

Como visto anteriormente, os valores das propriedades s�o representados em vetores de dados. 
Vetores de propriedade de mapa, por exemplo, t�m dimens�o 4 (ni x nj x nk x n�mero de timesteps de 
mapa) e s� podem ser usados em opera��es com outros vetores de mapa de 
mesmas dimens�es. � permitida a cria��o de ``fatias'' (\emph{slices}) que fazem 
refer�ncia a uma parte de um vetor 4D, ou seja, pode-se representar uma 
propriedade de uma camada de um reservat�rio atrav�s de uma refer�ncia ao 
vetor 4D, onde a terceira dimens�o � fixada.

As dimens�es de uma fatia que representa uma camada s�o: ni x nj x 1 x n�mero 
de timesteps de mapa. Conceitualmente, uma camada � um vetor 3D, j� que o 
�ndice k n�o varia. No entanto, internamente, ela � representada por um vetor 
4D, como se os valores associados � camada em quest�o fossem replicados para 
as demais camadas do grid. Desta forma, pode-se fazer opera��es entre um grid 
e uma camada espec�fica. Generalizando, pode-se fazer opera��es entre vetores 
e fatias de vetores de mesmas dimens�es. Tamb�m � poss�vel associar uma fatia 
a um modelo, para ser visualizada atrav�s da interface gr�fica. Neste caso, os 
valores s�o replicados ao longo das dimens�es fixadas.

Conceitualmente, uma propriedade de campo � um vetor 1D (n�mero de 
timesteps), uma propriedade de regi�o � um vetor 2D (n�mero de regi�es x 
n�mero de timesteps), uma propriedade de grupo � um vetor 2D (n�mero de 
grupos x n�mero de timesteps), uma propriedade de po�o � um vetor 2D 
(n�mero de po�os x n�mero de timesteps), e uma propriedade de completa��o � 
um vetor 3D (n�mero de po�os x n�mero de completa��es x n�mero de 
timesteps).

Em todas as opera��es que envolvem dois vetores de dados como operandos, a 
opera��o s� � poss�vel se os timesteps associados aos vetores forem compat�veis. 
O primeiro operando � usado com refer�ncia na opera��o. Para cada timestep 
existente no primeiro operando, deve haver um timestep correspondente no 
segundo operando. A correspond�ncia entre timesteps � feita buscando-se a 
ocorr�ncia entre datas pr�ximas, dentro de uma determinada toler�ncia, que pode
ser configurada pelo programador. Se a opera��o entre dois vetores n�o puder ser
realizada, o sistema reporta uma mensagem de erro. 
De posse de um vetor de dados, pode-se fazer diversas 
opera��es e invocar diversos m�todos associados.
� poss�vel realizar as opera��es aritm�ticas 
\footnote{Tamb�m � poss�vel realizar opera��es aritm�ticas entre vetores
de propriedades e valores escalares.}
de soma, subtra��o, multiplica��o, divis�o e potencia��o.
Essas opera��es resultam em um novo vetor de dados, de mesmas
dimens�es, onde cada valor representa a opera��oaplicada aos
valores associados aos vetores fornecidos.\cite{Tecg06}

Est�o dispon�veis tamb�m operadores relacionais e l�gicos 
e alguns m�todos de manipula��o de valores.

%Escrever sobre o atual sistema de script. \cite{Tecg06}

\chapter{Calculadora de propriedades}

Como visto anteriormente, um recurso interessante do sistema de \script{} � 
a possibilidade de us�-lo como uma esp�cie de m�quina de calcular que opera
sobre os dados de modelos de reservat�rios. Sendo assim, a primeira solu��o
encontrada para resolver o problema apresentado na introdu��o, oferecer
parte dos recursos do sistema de \script{} para o usu�rio n�o programador,
foi implementar justamente uma calculadora de propriedades onde o resultado
das opera��es fossem propriedades que pudessem ser posteriormente visualizadas pelo
usu�rio. Sendo assim, a ferramenta proposta deveria ter uma interface gr�fica
na forma de uma calculadora e gerar um c�digo compat�vel com o sistema
de \script{} e que obviamente resultasse na propriedade desejada pelo
usu�rio.

\section{Sintaxe das express�es}

Inicialmente a calculadora foi pensada para funcionar apenas para propriedades de
mapa. As propriedades de mapa s�o valores associados �s c�lulas do modelos, por
isso o acesso aos dados dessas propriedades � sempre independente dos demais
objetos vistos na se��o 2.2. Portanto, a sintaxe das express�es deveria ser
a sintaxe comum de express�es aritm�ticas levemente modificada para atender tr�s
requisitos: 

\begin{enumerate}
  \item Possibilitar o uso n�o somente de propriedades mas tamb�m de ``fatias'' 
  de propriedades com o timestep fixado.
  \item Permitir o uso de fun��es, para incluir outras funcionalidades do sistema
  de \script{}.
  \item Ser compat�vel com \textbf{Lua}, para facilitar a implementa��o.
\end{enumerate}

As ``fatias'' foram incluidas da seguinte forma: uma fatia � o nome de propriedade
(identificador) seguido de uma data entre aspas, como por exemplo:
 SO``10/10/2010''.
Em \textbf{Lua}, essa express�o � encarada como uma chamada de fun��o.

Posteriormente, foram  inclu�das na calculadora tamb�m propriedades de campo,
regi�o, grupo e po�o. No caso de tais propriedades, abriu-se a possibilidade de incluir
tamb�m os respectivos elementos nas express�s. Dessa manera, a fatia da propriedade associada
a um elemento (grupo, regi�o ou po�o) seria referenciada da seguinte maneira: nome
do elemento seguido do nome da propriedade entre colchetes, como por exemplo:
WELL[BHP]. Isso indicaria a fatia da propriedade BHP associada ao po�o WELL.
Em \textbf{Lua}, essa ecpress�o � encarada como uma indexa��o de uma tabela.

\section{Implementa��o}

A calculadora foi implementada na linguagem de programa��o \textbf{Lua} e a interface gr�fica
foi implementada utilizando o toolkit para constru��o de interfaces gr�ficas IUP.
\cite{IUP}
A implementa��o foi dividida em tr�s m�dulos: Calculator.lua, que implementa a interface
gr�fica e controla a entrada de dados do usu�rio, CalcComp.lua, respons�vel pela gera��o
de c�digo e valida��o das express�es e por �ltimo CalcLib.lua, que implementa algumas fun��es para
serem incluidas no sistema de \script{} que garantem o funcionamento do c�digo gerado.

\subsection{M�dulo Calculator.lua}

    \begin{figure}[!htb]
    %\begin{figure}
      \centering
      \includegraphics[bb= 0 0 534 257,width=\textwidth]{calc1.JPG}
      \caption{Interface da Calculadora}
      \label{interface}
    \end{figure}

A interface � composta pelos seguintes campos: 
\begin{itemize}
  \item Um campo de texto onde � poss�vel entrar o nome da nova propriedade,
  caso n�o seja especificado um nome, � usado a pr�pria express�o como nome.
  \item Lista que indica o tipo de propriedade que ser� calculada, atualmente
  os tipos suportaqdos s�o propriedade de mapa, campo, regi�o e po�o.
  \item Um toggle %TODO: achar uma tradu�ao para isso
  e a lista de elementos, que � preencida de acordo com o valor da lista de tipos,
  se o tipo for mapa, esses dois controles n�o s�o habilitados, pois n�o se aplicam
  a propriedades destes tipos.
  \item Lista de propriedades, que � preenchida de acordo com o valor da lista de tipos.
  \item Um toggle e lista de timesteps, que � preenchida de acordo com o valor da lista de tipos.
  \item Bot�o de inserir propriedade.
  \item ``Teclado'' formado por bot�es que disponibilizam os n�meros, os operadores e algumas
  fun��es para o usu�rio.
  \item Um campo de texto onde pode-se visualizar a express�o.
  \item Bot�es de calcular e limpar express�o.
\end{itemize}

A interface funciona da seguinte forma: o usu�rio pode entrar n�meros e operadores ou movimentar
o cursor livremente atrav�s de seu teclado ou clicando no teclado virtual da interface.
J� a entrada de vari�veis(propriedades) e fun��es s� pode ser feita atrav�s da interface gr�fica.
O objetivo disso � evitar a gera��o de c�digos inconsistentes.

Para se inserir fun��es basta-se clicar no respectivo bot�o da fun��o no teclado virtual para
que a fun��o seja inserida na posi��o corrente do cursor.

Para se inserir propriedades � preciso clicar no bot�o inserir ao lado da lista de timesteps.
O valor inserido depende dos valores das listas e dos toggles. Se nenhum dos toggles estiver
habilitado, ser� inserido apenas o nome da propriedade selecionada na lista de propriedades.
Se o toggle da lista de elementos estiver habilitado, ser� inserido a propriedade selecionada
na lista de propriedades indexando o elemento selecionado na lista de elementos
(exemplo: WELL[BHP]).
Caso o toggle de timestep esteja habilitado, ser� adicionado ao fim a data selecionada
na lista de timesteps (exemplo: SO``10/10/2010'').

Para que n�o haja casos de entrada de n�meros, operadores, fun��es ou propriedades em 
posi��es indesejadas (como por exemplo no meio do nome de uma propriedade) foram implementadas
algumas fun��es que controlam o movimento e posi��o do cursor, evitando cen�rios desse tipo.

%TODO: nao falei que as listas s�o preenchidas com vlores referentes ao modelo aberto.

\subsection{M�dulo CalcComp.lua}

Quando se pensa em gera��o de c�digo para um problema como este, a primeira abordagem que
nos vem a cabe�a � compilar  as express�es e gerar o c�digo desejado a partir delas.
Por�m, compilar c�digos, por mais simples que sejam as express�es
encontradas nesse caso, n�o � uma tarefa trivial. O desenvolvimento de um mini-compilador 
envolveria a implementa��o de um parser,
a elabora��o de uma gram�tica, o uso de t�cnicas como cria��o de �rvores de sintaxe
e etc. Por isso, a abordagem que foi seguida vai praticamente na dire��o oposta.
Em vez de compilar as express�es e gerar um c�digo de \script{} a partir delas
, o que fizemos foi adaptar o ambiente do sistema de \script{} 
para que as pr�prias express�es pudessem ser executadas dentro desse ambiente
e gerar o resultado esperado. � por isso que era imprescind�vel que as
express�es fossem compat�veis com \textbf{Lua}.

As adapta��es s�o feitas da seguinte maneira: � desempenhada uma itera��o sobre
os identificadores presentes na express�o (nomes de propriedades ou dos demais
elementos, como nomes de po�os), � verificado se o identificador se refere a uma propriedade
ou a um elemento e ent�o � gerado um c�digo que inicializa uma vari�vel local de mesmo
nome da propriedade ou elemento com uma chamada de fun��o que retorna um objeto
especial que possibilite a execu��o do c�digo da express�o. Essa fun��o recebe como par�metro
uma refer�ncia para o objeto que representa o modelo de reservat�rio, um \emph{string}
indicando o tipo de dado sendo trabalhado (propriedade de mapa, de po�o e etc) e um
\emph{string} contendo o nome da propriedade ou objeto. Al�m disso, tamb�m � gerado
o c�digo que armazena o resultado da express�o em uma vari�vel tempor�ria e
o da chamada de fun��o que associa o vetor de dados resultante ao modelo
para ser posteriormente visualizado.

Segue abaixo o exemplo de um c�digo gerado pelo m�dulo para a express�o OIL1[QO] + QW``10/07/1981'':

\begin{verbatim}
  calc.GetMacroEnv()
  local OIL1 = calc.CreateElem(rf,"well","OIL1")
  local QO = calc.CreateProp(rf,"well","QO")
  local QW = calc.CreateProp(rf,"well","QW")
  local newprop = OIL1[QO] + QW"10/07/1981"
  calc.AttachProp(rf,temp,'newprop','well')
\end{verbatim}

Nesse caso, QO e QW s�o propriedades de po�os, OIL1 � o nome de um po�o e rf representa
um objeto do tipo \emph{Model}.

A implementa��o dessas fun��es e dos objetos retornados por elas ser� discutida
na pr�xima se��o.

%TODO: explicar melhor o teste
O m�dulo tamb�m disponibiliza uma fun��o que testa a express�o com o intuito de 
prevenir erros de sintaxe e que fun��es sejam chamadas sem que seus par�metros tanham
sido especificados.

%descri��o da gera��o de c�digo.
%explicar que o c�digo n�o eh compilado, o que 
%acontece eh a adicao de algumas linhas de c�digo para
%que a execu��o da propria expressao j� gere o resultado
%esperado.

\subsection{M�dulo CalcLib.lua}

O m�dulo CalcLib.lua � respons�vel por implementar as fun��es presentes
no c�digo gerado pelo m�dulo CalcComp.lua. Essas fun��es servem para
adaptar o ambiente do sistema de \script{} para que as pr�prias express�es
possam ser executadas dentro desse ambiente e gerar o resultado esperado.
As fun��es s�o armazenadas em uma tabela que � inserida no ambiente de
\script{} (tabela calc). O principal desafio de implementar esse m�dulo
foi desenvolver objetos que se comportassem ora como operandos de 
express�es aritm�ticas e ora como fun��es (no caso de propriedades
com o timestep especificado, que � interpretado em  \textbf{Lua} como uma chamada
de fun��o). Uma limita��o que tamb�m teve que ser superada foi a de que,
em opera��es aritm�ticas entre vetores de dados e escalares no sistema de \script{},
os escalares devem sempre ser o segundo operando.

Para solucionar esses problemas, foi utilizado o recurso de meta-mecanismos
presente em \textbf{Lua}, que nos permite especificar como determinados objetos devem se
comportar em algumas situa��es. Isso � disponibilizado por meio da implementa��o 
de \emph{metatables}, que s�o tabelas que definem atrav�s de seus \emph{metam�todos}
como os objetos associados a ela devem se comportar.

Os objetos retornados pela fun��o \emph{CreateProp}, que representam as
propriedades nas express�es, s�o tabelas que possuem campos que
especificam o nome da propriedade, o tipo da propriedade e se o valor utilizado
nos c�lculos ser� a propriedade associada a um determinado elemento ou ser�
o vetor de dados inteiro. Seu comportamento (determinado por sua \emph{metatable})
� o seguinte: 

\begin{itemize}
  \item O metam�todo de todas as opera��es bin�rias ajusta a ordem dos
  termos, armazena o resultado da opera��o em um objeto intermedi�rio
  e o retorna.
  \item O metam�todo respons�vel pela situa��o em que o objeto � chamado 
  como uma fun��o, armazena a ``fatia'' da propriedade referente ao timestep passado como
  par�metro em um objeto intermedi�rio e o retorna.
  \item O metam�todo respons�vel pelo tratamento de indexa��es %inexistentes
  � o respons�vel por buscar os vetores de dados que ser�o usados nos c�lculos, por 
  isso os demais metam�todos acessam esses valores apenas indexando a pr�pria tabela. 
\end{itemize}

O objeto intermedi�rio, que � apenas uma tabela que armazena o resultado das opera��es,
se mostrou necess�rio para resolver a limita��o da ordem dos termos em opera��es envolvendo
escalares citada acima. Ele � associado � mesma \emph{metatable} do objeto que representa as
propriedades e por isso sempre ajusta a ordem dos termos nas opera��es.

%TODO: melhorar esse paragrafo
Os objetos que representam nas express�es os elementos (po�os, regi�es e etc), 
s�o criados pela fun��o \emph{CreateElem}. Eles s�o tabelas contendo campos
com o nome do elemento, o seu tipo e uma refer�ncia para o modelo que pertence.
A \emph{metatable} que � associada a eles cont�m apenas o metam�todo respons�vel 
pelo tratamento de indexa��es. Ao ser indexada por um objeto que representa uma propriedade,
esse metam�todo extrai o nome da propriedade e cria um novo objeto para mesma preopriedade
(chamando a fun��o \emph{CreateProp}) por�m especificando que a propriedade est� 
associada agora ao elemento. Portanto, o vetor de dados utilizado nos c�lculos ser�
referente a ``fatia'' da propriedade referente a esse elemento.

A fun��o \emph{AttachProp} associa o resultado da express�o ao modelo. 

Este m�dulo tamb�m inplementa as fun��es dispon�veis na interface da calculadora:

\begin{itemize}
  \item \textbf{max}: retorna o maior valor encontrado dentre os vetores de dados passados como
  par�metros.
  \item \textbf{min}: retorna o menor valor encontrado dentre os vetores de dados passados como
  par�metros.
  \item \textbf{sum}: retorna o somat�rio dos valores do vetor de dados.
  \item \textbf{abs}: retorna um novo vetor de dados de mesma dimens�es do vetor passado como
  par�metros com os valores sendo igual aos respectivos valores absolutos do vetor original.
  \item \textbf{sqrt}: retorna um novo vetor de dados de mesma dimens�es do vetor passado como
  par�metros com os valores sendo igual �s respectivas raizes quadradas dos valores do vetor original.
  \item \textbf{delta}: retorna um novo vetor de dados de mesma dimens�es do vetor passado como
  par�metros com os valores sendo igual diferen�a entre posi��es vizinhas.
\end{itemize}

\chapter{Linguagens de Programa��o Visual}

Ultimamente o uso de ferramentas de programa��o visual vem crescendo cada vez mais,
principalmente em aplica��es voltadas para �reas da engenharia como \emph{LabVIEW},
\emph{Simulink}, \emph{CircuitMaker} entre outros.
%Mesmo sem ter apresentado muito sucesso
Mesmo tendo apresentado relativa dificuldade
na resolu��o de problemas de grande porte
o uso destas ferramentas em sistemas que apresentam um dom�nio espec�fico,
como as citadas acima, tem se mostrado bastante interessante pois � poss�vel
manter-se dentro do estilo de comunica��o do dom�nio utilizando artefatos 
visuais que reflitam necessidades particulares, diagramas e o vocabul�rio
espec�fico do dom�nio 
sem nunca precisar deixar esse estilo de comunica��o. Al�m disso,
linguagens de programa��o visual costumam ser mais intuitivas e
de mais f�cil aprendizado do que linguagens de programa��o convencionais.

Pelos motivos citados acima, e pela calculadora de propriedades oferecer
relativamente poucos recursos ao usu�rio, se mostrou interessante um
estudo dessas ferramentas de programa��o visual e investigar se esse
tipo de recurso solucionaria o nosso problema.

Dentre os sistemas que utilizam programa��o visual, o que tem se destacado mais
� o \emph{LabVIEW (Laboratory Virtual Instrument Engineering Workbench)} [WhNF06], 
que � um ambiente de programa��o visual muito usado nos campos de aquisi��o de 
dados, controle de instrumentos e automa��o industrial. 
Por ser um instrumento amplamente usado por engenheiros em diversas �reas,
e como esses s�o os usu�rios finais do \textbf{Geresim}, essa ferramenta
se mostra uma interessante fonte de pesquisa e um poss�vel modelo a ser seguido, 
j� que � poss�vel que parte dos usu�rios finais tenha uma certa experi�ncia
com o \emph{LabVIEW}.

A linguagem de programa��o do \emph{LabVIEW}, chamada de G, � formada por elementos
visuais e textuais. Os elementos visuais s�o basicamente pequenas caixas (que 
podem representar valores, operadores e chamadas de fun��es) e linhas que as conectam. 
Elementos compostos como fun��es condicionais e de repeti��o (loop) s�o representados
por grandes caixas retangulares cercando o corpo da composi��o.

A linguagem segue o paradigma de fluxo de dados. O princ�pio central do paradigma
� definir a computa��o como um conjunto de depend�ncias de dados. Um programa 
escrito nesse paradigma define um grafo de n�s operadores (fun��es) unidos por 
arcos conectores. Os arcos s�o as depend�ncias de dados. Assim o paradigma de fluxo
de dados expressa computa��o como uma s�rie de transforma��es nos valores dos dados. 
N�o h� conceitos como vari�veis, ponteiros e atribui��o, o foco est� em quais fun��es 
ser�o aplicadas nos valores para produzir o retorno esperado. Outra caracter�stica 
desse paradigma � o paralelismo. A ordem de execu��o � baseada somente nas depend�ncias
de dados, o que � relativamente similar ao design de circuitos el�tricos.

Conceitualmente os programas desenvolvidos no \emph{LabVIEW} s�o compostos de fun��es,
que recebem o nome de instrumentos virtuais (VIs).
O c�digo de um VI consiste basicamente de tr�s elementos: terminais, n�s e fios conectores.
Os elementos terminais s�o os valores manipulados, podendo ser valores de entrada, sa�da ou
valores constantes. Esses elementos s�o representados por pequenas caixas coloridas com a 
cor do tipo do terminal (por exemplo, laranja para n�meros). Os n�s s�o operadores, chamados 
de fun��o e n�s estruturais (if-then-else, case, while etc). Operadores e chamadas de fun��o 
s�o representados por �cones com etiquetas ou imagens, e os n�s estruturais s�o representados 
por grandes caixas retangulares que delimitam a composi��o que deve ser executada dentro 
da estrutura. Os fios conectores s�o usados para ligar terminais e n�s formando express�es.

\chapter{In�cio da implementa��o de uma VPL}

Ap�s o estudo de VPLs e e algumas experi�ncias utilizando o \emph{LabVIEW}
(na mat�ria Automa��o Industrial, cursada nesse per�odo), foi iniciada
a implementa��o de uma VPL bastante simplificada que segue o paradigma de
fluxo de dados. Infelizmente n�o houve tempo suficiente para desenvolver
mais a ferramenta e por isso a implementa��o econtra-se em estado inicial.

Ao contr�rio do que foi feito na calculadora de propriedades, inicialmente
seria implementado algo mais gen�rico para depois ser especializado para
o ambiente de p�s-processamento do \textbf{Geresim}. A princ�pio, a linguagem
seria composta apenas de blocos e fios conectores que denotariam
as depend�ncias de  dados entre os blocos. Um bloco poderia ter
mais de um dado de entrada e mais de um dado de sa�da.
Sua compila��o geraria um c�digo \textbf{Lua}.

No c�digo gerado, cada bloco seria representado por uma tabela.
Essa tabela aramzenaria a fun��o associada ao bloco e uma lista
de objetos par�metros, que seriam tabelas armazenando uma refer�ncia
a outro bloco e o �ndice do dado de sa�da deste outro bloco. 
Todos os blocos estariam associados a uma \emph{metatable} cujo
metam�todo de indexa��o executaria a fun��o do bloco gerando assim
os dados de sa�da. Por�m, antes de poder executar a fun��o associada
a este bloco, seria preciso obter todos os par�metros. E isso seria
feito iterando a lista de par�metros e indexando os respectivos
blocos com os respectivos �ndices. Caso os dados de sa�da desses
demais blocos n�o estejam dispon�veis, o metam�todo de indexa��o agiria
ent�o nesses blocos. Logo, recursivamente toda a cadeia de blocos seria
executada. Dessa maneira, a compila��o seria apenas uma itera��o sobre os fios
conectores e a partir deles se geraria a lista de par�metros de cada bloco.

A partir da base descrita acima, j� seria poss�vel implementar um bloco
que desempenhe a fun��o de um operador condicional e talvez seja
poss�vel implementar um bloco de itera��o.

No atual est�gio da implementa��o � poss�vel manipular os blocos
com o mouse e conecta-los com os fios conectores. � poss�vel tamb�m
manipular blocos j� conectados, fazendo com que os fios conectores se
redesenhem se ajustando � nova disposi��o dos blocos.
Essa implementa��o foi desenvolvida em \textbf{C}++, utilizando a API gr�fica
\emph{OpenGL}.\cite{OpenGl} 
A parte \textbf{Lua} ainda n�o foi desenvolvida.


\chapter{Considera��es finais e projetos futuros}

Neste trabalho foi apresentado um sistema de \script{} de uma aplica��o
voltada para o p�s-processamento de simula��es de reservat�rios de petr�leo (\textbf{Geresim})
e a proposta e implementa��o de uma ferramenta que disponibilza parte 
dos recursos  obtidos a partir dos \emph{scripts} � usu�rios n�o programadores.
Essa ferramenta �
uma calculadora de propriedades que permite que o usu�rio gere novas 
propriedades a partir de simples express�es aritm�ticas desenvolvidas em
uma interface gr�fica similar a uma calculadora comum. A ferramenta
ainda n�o foi utilizada por usu�rios finais, mas j� est� integrada ao
sistema e ap�s ser testada e aprovada por outros membros da equipe de desenvolvimento da
aplica��o criou uma boa expectativa em rela��o ao cumprimento de seu objetivo.
A ferramenta estar� dispon�vel na pr�xima vers�o do programa, que
ser� lan�ada em breve.

Adicionalmente, foram feitos estudos acerca de linguagens de programa��o visual.
Dentre os sistemas que utilizam esse recurso, o que se mostrou mais interessante
foi o \emph{LabVIEW}, pois � amplamente usado por usu�rios que apresentam um perfil
similar aos usu�rios do \textbf{Geresim}.
Ap�s esse estudo foi iniciada a 
implementa��o de uma VPL bastante simplificada que segue o paradigma de 
fluxo de dados. Infelizmente n�o houve tempo suficiente para desenvolver mais 
a ferramenta e por isso sua finaliza��o passa a ser um projeto para o futuro.

Outro projeto futuro � aumentar o escopo de atua��o da calculadora
incluindo as propriedades de complet��o e incluindo a op��o de
se trabalhar com camadas e se��es das propriedades de mapa.

\arial
\bibliography{thesispucLeo}

\normalfont
%\begin{thenotations}
% %------------------------------------------------------------------------------%
% \section*{Simplicial Complex}
% %------------------------------------------------------------------------------%
% %
% \noindent
% \begin{tabular}{ll}
% \mathbb{R} & conjunto dos n�meros reais \\
% \end{tabular}
%
%\end{thenotations}
%\printindex

\appendix

\chapter{Exemplos pr�ticos}

\section{C�lculo da raz�o gas-oleo (RGO)}

Express�o: QG / QO

C�digo gerado:

\begin{verbatim}
calc.GetMacroEnv()
local QG = calc.CreateProp(rf,"well","QG")
local QO = calc.CreateProp(rf,"well","QO")
local RGO = QG /QO 
calc.AttachProp(rf,RGO,'RGO','well')
\end{verbatim}

\section{C�lculo sedimentos b�sicos e �gua (BSW)}

Express�o: QW /(QW + QO )

C�digo gerado:

\begin{verbatim}
calc.GetMacroEnv()
local QW = calc.CreateProp(rf,"well","QW")
local QO = calc.CreateProp(rf,"well","QO")
local BSW = QW /(QW + QO )
calc.AttachProp(rf,BSW,'BSW','well')
\end{verbatim}

\section{C�lculo do volume de �leo em condi��es de reservat�rio}

Express�o: H * PHI * SO * DX * DY

C�digo gerado:

\begin{verbatim}
  calc.GetMacroEnv()
  local H = calc.CreateProp(rf,"map","H")
  local PHI = calc.CreateProp(rf,"map","PHI")
  local SO = calc.CreateProp(rf,"map","SO")
  local DX = calc.CreateProp(rf,"map","DX")
  local DY = calc.CreateProp(rf,"map","DY")
  local temp = H *PHI *SO *DX *DY
  calc.AttachProp(rf,temp,'H *PHI *SO *DX *DY ','map')
\end{verbatim}



\begin{figure}
   %\includegraphics*[width=\linewidth]{calc1.PNG}
   %\includegraphics[width=2cm]{vis1.JPG}
   \includegraphics[bb= 0 0 523 348,width=\textwidth]{vis4.JPG}
   \caption{Exemplo de visualiza��o}
   %\label{visualiza��o}
 \end{figure}



\end{document}
